var COOKIES="weather-locations",COOKIES_LENGTH=1825,STATE={WEATHER:1,CONFIG:2},YAHOO={PREFIX:"http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20weather.forecast%20where%20woeid%20in%20(select%20woeid%20from%20geo.places(1)%20where%20text%3D%22",POSTFIX:"%22)%20and%20u%20=%20%27c%27&format=json&env=store%3A%2F%2Fdatatables.org&u=c"},ICON={SUNNY:"./img/Sunny.png",CLOUD:"./img/Cloudy.png",PART_CLOUD:"./img/Mostly Cloudy.png",MIST:"./img/Haze.png",HAZE:"./img/Haze.png",FOGGY:"./img/Haze.png",RAIN:"./img/Drizzle.png",LIST_RAIN:"./img/Slight Drizzle.png",SNOW:"./img/Snow.png",NA:"./img/na.png",PREFIX:'<img width="100px" height="100px" src="',POSTFIX:'" alt="weather icon">'},lockOrientation=screen.lockOrientation||screen.mozLockOrientation||screen.msLockOrientation;lockOrientation&&lockOrientation(["portrait-primary","portrait-secondary"]),$ch.use(["./chop-bundle"],function(){"use strict";function a(){var a=$ch.readFile("weather_template.html");$ch.scope("appScope",function(c,e){c.container.html(a),e.listen("goConfig",function(){var e=$ch.source("state");if(e===STATE.WEATHER){$ch.source("state",STATE.CONFIG);var g=$ch.readFile("./details_template.html");c.container.html(g),d()}else $ch.source("state",STATE.WEATHER),f=$ch.source("locations")||f.join("\n"),f=f.split("\n"),f=f.map(function(a){return a.trim()}),$ch.store.cookie(COOKIES,f.join("&"),COOKIES_LENGTH),c.container.html(a),b()})})}function b(){$ch.scope("weatherScope",function(a,b){var d=[];a.touch={start:0,end:0},a.weatherItem.on("touchmove",function(a){a.preventDefault()}),a.weatherItem.on("touchstart",function(b){var c=b.touches[0];a.touch={start:0,end:0},a.touch.start=c.pageX}),a.weatherItem.on("touchmove",function(c){var d=c.touches[0];a.touch.end=d.pageX;var e=a.touch,f=e.end-e.start,g=e.start-e.end;$ch.find(".weather-item",a.weatherItem.el).css("left",f+"px").css("right",g+"px"),f>100?b.emit("goNext"):g>100&&b.emit("goPrevious")}),a.weatherItem.on("touchend",function(){$ch.find(".weather-item",a.weatherItem.el).css("left","0").css("right","0")}),e(),b.listen("retrieve weather",function(){f.forEach(function(b,e){var f=YAHOO.PREFIX+b+YAHOO.POSTFIX;$ch.http(f,{done:function(b){if(200===b.status||304===b.status){var f=JSON.parse(b.responseText);if(d[e].raw=f,f=f.query,0===f.count?(d[e].temp="?",d[e].icon=ICON.PREFIX+ICON.NA+ICON.POSTFIX,d[e].text=""):(f=f.results.channel.item.condition,d[e].ready=!0,d[e].temp=f.temp,d[e].text=f.text,d[e].name=d[e].name.split(",")[0].trim(),d[e].icon=ICON.PREFIX+c(f.text)+ICON.POSTFIX,d[e].text=d[e].text.toLowerCase().replace(/\ /g,"-")),e===a.index){var g=$ch.template(a.template,d[e]);a.weatherItem.html(g)}}}})})}),b.listen("goPrevious",function(){a.index-=1,a.index<0&&(a.index=d.length-1),$ch.source("current index",a.index);var b=$ch.template(a.template,d[a.index]);a.weatherItem.html(b)}),b.listen("goNext",function(){a.index+=1,a.index>d.length-1&&(a.index=0),$ch.source("current index",a.index);var b=$ch.template(a.template,d[a.index]);a.weatherItem.html(b)});for(var g=0,h=f.length;g!==h;++g)d.push({name:f[g].toUpperCase().split(",")[0].trim(),ready:!1,temp:0,text:"loading...",icon:ICON.PREFIX+"./img/na.png"+ICON.POSTFIX});a.index=$ch.source("current index"),a.template=$ch.readFile("./weather_item_template.html");var i=$ch.template(a.template,d[0]);a.weatherItem.html(i),b.emit("retrieve weather"),window.setInterval(function(){b.emit("retrieve weather")},6e4)})}function c(a){switch(a=a.toUpperCase()){case"SUNNY":case"CLEAR":case"FAIR":return ICON.SUNNY;case"CLOUDY":case"MOSTLY CLOUDY":return ICON.CLOUD;case"PARTLY CLOUDY":return ICON.PART_CLOUD;case"MIST":return ICON.MIST;case"HAZE":return ICON.HAZE;case"FOG":return ICON.FOGGY;case"RAIN":case"DRIZZLE":return ICON.RAIN;case"LIGHT RAIN":case"LIGHT DRIZZLE":return ICON.LIST_RAIN;case"THUNDER":return ICON.THUNDER;case"WINDY":return ICON.WINDY;case"UNKNOWN":return ICON.NA}}function d(){$ch.scope("configScope",function(a,b){b.listen("load",function(a){var b=[];f.forEach(function(a,c){b.push({name:a,id:c})}),a.list.inline(b)}),b.listen("addLocation",function(){var c=a.input.get()||"";if(c=c.trim(),c.match(/\w+/)){var d=$ch.store.cookie(COOKIES);d+="&"+c,$ch.store.cookie(COOKIES,d,COOKIES_LENGTH),f=d.split("&"),$ch.source("locations",f.join("\n")),b.emit("load",a),a.input.set("")}}),b.listen("keyLocation",function(a){13===a.keyCode&&b.emit("addLocation")}),b.emit("load",a),$ch.event.listen("remove location",function(c){var d=$ch.store.cookie(COOKIES),e=new RegExp(c+"\\&?","g");d=d.replace(e,""),"&"===d[d.length-1]&&(d=d.substring(0,d.length-1)),$ch.store.cookie(COOKIES,d,COOKIES_LENGTH),f=d.split("&"),$ch.source("locations",f.join("\n")),b.emit("load",a)})})}function e(){var a=$ch.scope("weatherScope");a&&$ch.find("body").on("keyup",function(b){37===b.keyCode?a._eventHandler.emit("goPrevious"):39===b.keyCode&&a._eventHandler.emit("goNext")})}var f=$ch.store.cookie(COOKIES)||"Manchester, UK & Beijing, China & Seattle, US";f=f.split("&"),f=f.map(function(a){return a.trim()}),$ch.event.listen("show weathers",function(){a(),b()}),$ch.source("current index",0),$ch.source("state",STATE.WEATHER),$ch.event.emit("show weathers")});